name: Auto Patch & Release APK

on:
  workflow_dispatch:
  schedule:
  # UTCの15:00（日本時間0:00）に実行
  - cron: '0 15 * * *'

jobs:
  patch_and_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.9"

      - name: Get latest release info from GitHub
        id: get_release_piko_and_origin
        run: |
          # monsivamon(lluniに変更 変数名は変わっていません)リポジトリから最新リリースタグを取得
          monsivamon_TAG=$(curl -s https://api.github.com/repos/crimera/twitter-apk/releases/latest | jq -r .tag_name)
          echo "monsivamon_TAG=${monsivamon_TAG}" >> $GITHUB_ENV
          
          # YuzuMikan404リポジトリの最新タグを取得
          YuzuMikan404_response=$(curl -s https://api.github.com/repos/YuzuMikan404/Origin-Twitter-Neo/releases/latest)
          if echo "$YuzuMikan404_response" | jq -e '.tag_name' >/dev/null 2>&1; then
            YuzuMikan404_TAG=$(echo "$YuzuMikan404_response" | jq -r .tag_name)
            echo "YuzuMikan404_TAG=${YuzuMikan404_TAG}" >> $GITHUB_ENV
            echo "✅ Found existing release tag: $YuzuMikan404_TAG"
          else
            echo "ℹ️  No existing release found or API error."
            echo "YuzuMikan404_TAG=" >> $GITHUB_ENV
          fi

      - name: Check if releases match
        id: check_releases
        run: |
          if [ -z "${{ env.YuzuMikan404_TAG }}" ]; then
            echo "No existing release found. Proceeding."
            echo "SKIP=false" >> $GITHUB_ENV
          elif [ "${{ env.monsivamon_TAG }}" == "${{ env.YuzuMikan404_TAG }}" ]; then
            echo "Releases match. Skipping."
            echo "SKIP=true" >> $GITHUB_ENV
          else
            echo "Releases differ. Proceeding."
            echo "SKIP=false" >> $GITHUB_ENV
          fi

      - name: Install requests and PyYAML
        if: ${{ env.SKIP == 'false' }}
        run: pip install requests PyYAML

      - name: Install dependencies
        if: ${{ env.SKIP == 'false' }}
        run: |
          sudo apt-get update && sudo apt-get install -y curl wget jq unzip openjdk-17-jdk

      - name: Install Android SDK & Build Tools
        if: ${{ env.SKIP == 'false' }}
        run: |
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O sdk-tools.zip
          unzip sdk-tools.zip
          mkdir -p $HOME/android-sdk/cmdline-tools
          mv cmdline-tools $HOME/android-sdk/cmdline-tools/latest
          export ANDROID_HOME=$HOME/android-sdk
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0:$PATH
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "PATH=$PATH" >> $GITHUB_ENV
          yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --install "platform-tools" "build-tools;34.0.0"

      - name: Install apktool
        if: ${{ env.SKIP == 'false' }}
        run: |
          wget -q https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -O /tmp/apktool
          wget -q https://github.com/iBotPeaches/Apktool/releases/download/v2.12.1/apktool_2.12.1.jar -O /tmp/apktool.jar
          sudo mv /tmp/apktool /usr/local/bin/
          sudo mv /tmp/apktool.jar /usr/local/bin/
          sudo chmod +x /usr/local/bin/apktool
          apktool --version

      - name: Create downloads directory
        if: ${{ env.SKIP == 'false' }}
        run: mkdir -p downloads

      - name: Download APK file
        if: ${{ env.SKIP == 'false' }}
        id: download_apk
        continue-on-error: true
        run: |
          set -e
          DOWNLOAD_URL="https://github.com/crimera/twitter-apk/releases/download/${{ env.monsivamon_TAG }}/twitter-piko-v${{ env.monsivamon_TAG }}.apk"
          OUTPUT_FILE="downloads/twitter-piko-v${{ env.monsivamon_TAG }}.apk"
          
          echo "Downloading from: $DOWNLOAD_URL"
          curl -v -L -f "$DOWNLOAD_URL" -o "$OUTPUT_FILE"
          
          if [ -s "$OUTPUT_FILE" ]; then
            echo "apk_downloaded=true" >> $GITHUB_ENV
          else
            echo "apk_downloaded=false" >> $GITHUB_ENV
            exit 1
          fi

      # --- 修正: キーストアの復元 ---
      - name: Setup Signing Key
        if: ${{ env.SKIP == 'false' && env.apk_downloaded == 'true' }}
        run: |
          echo "Decoding keystore from secrets..."
          echo "${{ secrets.SIGNING_KEY }}" | base64 -d > origin-twitter.keystore

      # --- 修正: パッチ実行（Secretsを渡す） ---
      - name: Run Patch APK script
        if: ${{ env.SKIP == 'false' && env.apk_downloaded == 'true' }}
        env:
          STOREPASS: ${{ secrets.KEY_STORE_PASSWORD }}
          KEYPASS: ${{ secrets.KEY_PASSWORD }}
          ALIAS: ${{ secrets.ALIAS }}
        run: python patch_apk.py

      - name: Run Release APK script
        if: ${{ env.SKIP == 'false' && env.apk_downloaded == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.YuzuMikan404_TOKEN }}
        run: python release_apk.py


