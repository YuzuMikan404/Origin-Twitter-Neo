name: Auto Patch & Release APK

on:
  workflow_dispatch:

jobs:
  patch_and_release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.9"

      - name: Get latest release info from GitHub
        id: get_release_piko_and_origin
        run: |
          monsivamon_TAG=$(curl -s https://api.github.com/repos/monsivamon/twitter-apk/releases/latest | jq -r .tag_name)
          echo "monsivamon_TAG=${monsivamon_TAG}" >> $GITHUB_ENV
          YuzuMikan404_TAG=$(curl -s https://api.github.com/repos/YuzuMikan404/Origin-Twitter/releases/latest | jq -r .tag_name)
          echo "YuzuMikan404_TAG=${YuzuMikan404_TAG}" >> $GITHUB_ENV

      - name: Check if releases match
        id: check_releases
        run: |
          if [ "${{ env.monsivamon_TAG }}" == "${{ env.YuzuMikan404_TAG }}" ]; then
            echo "Releases match. Skipping download and processing."
            echo "SKIP=true" >> $GITHUB_ENV
          else
            echo "Releases differ. Proceeding with download and processing."
            echo "SKIP=false" >> $GITHUB_ENV
          fi

      - name: Install requests and PyYAML
        if: ${{ env.SKIP == 'false' }}
        run: pip install requests PyYAML

      - name: Install dependencies
        if: ${{ env.SKIP == 'false' }}
        run: |
          sudo apt-get update && sudo apt-get install -y curl wget jq unzip openjdk-17-jdk

      - name: Install Android SDK & Build Tools
        if: ${{ env.SKIP == 'false' }}
        run: |
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O sdk-tools.zip
          unzip sdk-tools.zip
          mkdir -p $HOME/android-sdk/cmdline-tools
          mv cmdline-tools $HOME/android-sdk/cmdline-tools/latest
          export ANDROID_HOME=$HOME/android-sdk
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0:$PATH
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "PATH=$PATH" >> $GITHUB_ENV
          yes | $HOME/android-sdk/cmdline-tools/latest/bin/sdkmanager --install "platform-tools" "build-tools;34.0.0"

      - name: Set environment variables
        if: ${{ env.SKIP == 'false' }}
        run: |
          echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
          echo "PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0:$PATH" >> $GITHUB_ENV

      - name: Install apktool
        if: ${{ env.SKIP == 'false' }}
        run: |
          # apktoolのインストール
          sudo apt-get install -y openjdk-17-jdk
          wget https://raw.githubusercontent.com/iBotPeaches/Apktool/master/scripts/linux/apktool -O /tmp/apktool
          wget https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.11.1.jar -O /tmp/apktool.jar
          
          sudo chmod +x /tmp/apktool /tmp/apktool.jar
          sudo mv /tmp/apktool /usr/local/bin/
          sudo mv /tmp/apktool.jar /usr/local/bin/
          
          echo "apktool version:"
          apktool --version

      - name: Print tool versions
        if: ${{ env.SKIP == 'false' }}
        run: |
          echo "Java version:"
          java -version
          echo "apktool version:"
          apktool --version
          echo "aapt2 version:"
          $HOME/android-sdk/build-tools/34.0.0/aapt2 version

      - name: Create downloads directory if not exists
        if: ${{ env.SKIP == 'false' }}
        run: mkdir -p downloads

      - name: Download APK file
        if: ${{ env.SKIP == 'false' }}
        run: |
          wget "https://github.com/monsivamon/twitter-apk/releases/download/${{ env.monsivamon_TAG }}/twitter-piko-v${{ env.monsivamon_TAG }}.apk" -O downloads/twitter-piko-v${{ env.monsivamon_TAG }}.apk

      - name: List files in downloads directory
        if: ${{ env.SKIP == 'false' }}
        run: ls -l downloads/

      - name: Run Patch APK script
        if: ${{ env.SKIP == 'false' }}
        run: python patch_apk.py

      - name: Build and sign APK
        if: ${{ env.SKIP == 'false' }}
        run: |
          # バージョンを取得
          CLEAN_VERSION=$(echo "${{ env.monsivamon_TAG }}" | sed 's/-release//g')
          echo "Clean version: $CLEAN_VERSION"
          
          # 入力ディレクトリ
          INPUT_DIR="decompiled-twitter-$CLEAN_VERSION"
          OUTPUT_DIR="patched_apks"
          KEYSTORE="origin-twitter.keystore"
          ALIAS="origin"
          STOREPASS="123456789"
          KEYPASS="123456789"
          
          # 入力ディレクトリの確認
          if [ ! -d "$INPUT_DIR" ]; then
            echo "Error: Input directory $INPUT_DIR does not exist."
            ls -la
            exit 1
          fi
          
          # 出力ディレクトリ作成
          mkdir -p "$OUTPUT_DIR"
          
          # APKのビルド
          echo "Building APK..."
          apktool b "$INPUT_DIR" -o "unsigned.apk"
          
          # ビルドの成否を確認
          if [ ! -f "unsigned.apk" ]; then
            echo "Error: Failed to build APK"
            exit 1
          fi
          
          # キーストアの確認
          if [ ! -f "$KEYSTORE" ]; then
            echo "Error: Keystore file $KEYSTORE not found"
            ls -la
            exit 1
          fi
          
          # APKの署名
          echo "Signing APK..."
          jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 \
            -keystore "$KEYSTORE" \
            -storepass "$STOREPASS" \
            -keypass "$KEYPASS" \
            "unsigned.apk" "$ALIAS"
          
          # zipalignで最適化
          echo "Optimizing APK..."
          $HOME/android-sdk/build-tools/34.0.0/zipalign -v 4 "unsigned.apk" "$OUTPUT_DIR/twitter-piko-v$CLEAN_VERSION-signed.apk"
          
          # 結果の確認
          if [ -f "$OUTPUT_DIR/twitter-piko-v$CLEAN_VERSION-signed.apk" ]; then
            echo "Build successful! APK saved to: $OUTPUT_DIR/twitter-piko-v$CLEAN_VERSION-signed.apk"
            ls -la "$OUTPUT_DIR/"
          else
            echo "Error: Failed to create signed APK"
            exit 1
          fi

      - name: Run Release APK script
        if: ${{ env.SKIP == 'false' }}
        env:
          GITHUB_TOKEN: ${{ secrets.YuzuMikan404_TOKEN }}
        run: python release_apk.py
