name: Patch and Release

on:
  workflow_dispatch:
    inputs:
      monsivamon_TAG:
        description: "Enter the monsivamon_TAG"
        required: true
        default: "11.68.0-release.0"
      YuzuMikan404_TAG:
        description: "Enter the YuzuMikan404_TAG"
        required: true
        default: "11.68.0-release.0"
      SKIP:
        description: "Skip the patching process? (true/false)"
        required: false
        default: "false"

jobs:
  patch_and_release:
    runs-on: ubuntu-latest
    env:
      monsivamon_TAG: ${{ inputs.monsivamon_TAG }}
      YuzuMikan404_TAG: ${{ inputs.YuzuMikan404_TAG }}
      SKIP: ${{ inputs.SKIP }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4

      - name: Install apktool
        run: |
          wget https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_3.0.1.jar -O apktool.jar
          echo "apktool installed: $(java -jar apktool.jar --version)"

      - name: Install Android SDK
        run: |
          wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
          mkdir -p $ANDROID_HOME/cmdline-tools
          unzip cmdline-tools.zip -d $ANDROID_HOME/cmdline-tools
          mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
          yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
          $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0" "platforms;android-34"
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0" >> $GITHUB_PATH

      - name: Install Java
        run: |
          sudo apt-get update
          sudo apt-get install -y openjdk-17-jdk
          export JAVA_OPTS="-Xmx6g"

      - name: Download APK file
        run: |
          set -e
          mkdir -p downloads  # Ensure directory exists
          DOWNLOAD_URL="https://github.com/lluni/twitter-apk/releases/download/$monsivamon_TAG/twitter-piko-v$monsivamon_TAG.apk"
          OUTPUT_FILE="downloads/twitter-piko-v$monsivamon_TAG.apk"

          echo "Downloading from: $DOWNLOAD_URL"
          curl -v -L -f "$DOWNLOAD_URL" -o "$OUTPUT_FILE"

          if [ -s "$OUTPUT_FILE" ]; then
            echo "apk_downloaded=true" >> $GITHUB_ENV
          else
            echo "apk_downloaded=false" >> $GITHUB_ENV
            exit 1
          fi

      - name: Patch APK
        if: env.apk_downloaded == 'true' && env.SKIP == 'false'
        run: |
          java -jar apktool.jar d downloads/twitter-piko-v${{ env.monsivamon_TAG }}.apk -o patched
          python patch.py
          java -jar apktool.jar b patched -o patched.apk

      - name: Sign APK
        if: env.apk_downloaded == 'true'
        run: |
          keytool -genkey -v -keystore my-release-key.keystore -keyalg RSA -keysize 2048 -validity 10000 -alias my-alias -dname "CN=Unknown, OU=Unknown, O=Unknown, L=Unknown, ST=Unknown, C=Unknown" -storepass password -keypass password
          apksigner sign --ks my-release-key.keystore --ks-pass pass:password --v1-signing-enabled --v2-signing-enabled patched.apk

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.YuzuMikan404_TAG }}
          files: patched.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
